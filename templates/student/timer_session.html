{% extends "base.html" %}

{% block title %}{{ timer_type.replace('_', ' ').title() }}{% endblock %}

{% block content %}
<style>
    .timer-container { text-align: center; padding: 2rem; }
    .timer-display { font-size: 4rem; font-weight: bold; color: var(--accent-primary); margin: 2rem 0; }
    .timer-controls { display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; }
    .focus-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
    .sound-control, .distraction-control { background: var(--bg-secondary); padding: 1rem; border-radius: 12px; border: 1px solid var(--glass-border); }
    .progress-bar { background: var(--bg-secondary); height: 10px; border-radius: 5px; margin: 1rem 0; }
    .progress-fill { background: var(--accent-primary); height: 100%; border-radius: 5px; width: 0%; transition: width 1s; }
    .sound-control h3, .distraction-control h3 { overflow-wrap: break-word; hyphens: auto; margin-bottom: 1rem; }
    .sound-control select { overflow-wrap: break-word; text-overflow: ellipsis; }
    .sound-btn { position: relative; overflow: hidden; }
    .sound-btn.playing { animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); }
        100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
    }
</style>

<div class="card timer-container">
    <h1>{{ timer_type.replace('_', ' ').title() }} ðŸŽ¯</h1>
    
    <div class="timer-display" id="timerDisplay">25:00</div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
    </div>
    
    <div class="timer-controls">
        <button class="btn btn-success" onclick="startTimer()">Start</button>
        <button class="btn" onclick="pauseTimer()">Pause</button>
        <button class="btn btn-danger" onclick="stopTimer()">Stop</button>
    </div>
    
    <div>
        <label for="duration">Duration (minutes):</label>
        <input type="number" id="duration" value="25" min="1" max="180" style="margin: 0 1rem; padding: 0.5rem;">
    </div>
</div>

<div class="focus-controls">
    <div class="sound-control">
        <h3>ðŸŽµ Sound & Environment</h3>
        <select id="soundSelect" onchange="handleSoundChange()" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; overflow-wrap: break-word;">
            <option value="none">No Sound</option>
            <option value="rain">Rain Sounds</option>
            <option value="forest">Forest Ambience</option>
            <option value="cafe">Cafe Noise</option>
            <option value="white-noise">White Noise</option>
            <option value="lofi">Lo-Fi Hip Hop</option>
            <option value="nature">Nature Sounds</option>
            <option value="ocean">Ocean Waves</option>
        </select>
        <button class="btn sound-btn" id="soundBtn" onclick="toggleSound()">Play Sound</button>
    </div>
    
    <div class="distraction-control">
        <h3>ðŸ”’ Focus Lock</h3>
        <label>
            <input type="checkbox" id="blockSocial"> Block Social Media
        </label><br>
        <label>
            <input type="checkbox" id="blockNews"> Block News Sites
        </label><br>
        <label>
            <input type="checkbox" id="blockGaming"> Block Gaming Sites
        </label><br>
        <button class="btn" onclick="enableFocusLock()">Enable Focus Lock</button>
    </div>
</div>

<div class="card">
    <h3>ðŸ“Š Session Stats</h3>
    <div class="stats">
        <div class="stat-item">
            <h3 id="interruptions">0</h3>
            <p>Interruptions</p>
        </div>
        <div class="stat-item">
            <h3 id="focusScore">100%</h3>
            <p>Focus Score</p>
        </div>
        <div class="stat-item">
            <h3 id="timeRemaining">25:00</h3>
            <p>Time Remaining</p>
        </div>
    </div>
</div>

<script>
let timerInterval;
let totalSeconds = 1500;
let remainingSeconds = totalSeconds;
let isRunning = false;
let sessionId = null;
let interruptions = 0;
let currentAudio = null;
let isPlaying = false;

// Audio file mappings
const audioFiles = {
    'rain': 'https://www.soundjay.com/misc/sounds/rain-01.mp3',
    'forest': 'https://www.soundjay.com/nature/sounds/forest-01.mp3',
    'cafe': 'https://www.soundjay.com/misc/sounds/cafe-01.mp3',
    'white-noise': 'https://www.soundjay.com/misc/sounds/white-noise-01.mp3',
    'lofi': 'https://www.soundjay.com/music/sounds/lofi-01.mp3',
    'nature': 'https://www.soundjay.com/nature/sounds/nature-01.mp3',
    'ocean': 'https://www.soundjay.com/nature/sounds/ocean-01.mp3'
};

function handleSoundChange() {
    if (isPlaying) {
        stopCurrentAudio();
    }
}

function toggleSound() {
    const soundSelect = document.getElementById('soundSelect');
    const soundBtn = document.getElementById('soundBtn');
    const selectedSound = soundSelect.value;
    
    if (selectedSound === 'none') {
        alert('Please select a sound first');
        return;
    }
    
    if (isPlaying) {
        stopCurrentAudio();
    } else {
        playAudio(selectedSound);
    }
}

function playAudio(soundType) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }
    
    // For demo purposes, using a simple beep sound
    // In production, replace with actual audio files
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Different frequencies for different sounds
    const frequencies = {
        'rain': 200,
        'forest': 150,
        'cafe': 300,
        'white-noise': 100,
        'lofi': 250,
        'nature': 180,
        'ocean': 120
    };
    
    oscillator.frequency.setValueAtTime(frequencies[soundType] || 200, audioContext.currentTime);
    oscillator.type = 'sine';
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    
    oscillator.start();
    
    // Store reference for stopping
    currentAudio = {
        oscillator: oscillator,
        context: audioContext,
        stop: () => {
            oscillator.stop();
            audioContext.close();
        }
    };
    
    updateSoundButton(true);
    isPlaying = true;
}

function stopCurrentAudio() {
    if (currentAudio) {
        currentAudio.stop();
        currentAudio = null;
    }
    updateSoundButton(false);
    isPlaying = false;
}

function updateSoundButton(playing) {
    const soundBtn = document.getElementById('soundBtn');
    if (playing) {
        soundBtn.textContent = 'Stop Sound';
        soundBtn.classList.add('playing');
    } else {
        soundBtn.textContent = 'Play Sound';
        soundBtn.classList.remove('playing');
    }
}

function startTimer() {
    if (!isRunning) {
        const duration = parseInt(document.getElementById('duration').value) * 60;
        if (remainingSeconds === totalSeconds) {
            totalSeconds = duration;
            remainingSeconds = duration;
            
            fetch('/api/start_timer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    timer_type: '{{ timer_type }}',
                    duration: duration
                })
            })
            .then(response => response.json())
            .then(data => sessionId = data.session_id);
        }
        
        isRunning = true;
        timerInterval = setInterval(updateTimer, 1000);
    }
}

function pauseTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    interruptions++;
    document.getElementById('interruptions').textContent = interruptions;
}

function stopTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    stopCurrentAudio();
    
    if (sessionId) {
        const completedDuration = totalSeconds - remainingSeconds;
        const focusScore = Math.max(0, 100 - (interruptions * 10));
        
        fetch('/api/end_timer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                completed_duration: completedDuration,
                interruptions: interruptions,
                focus_score: focusScore / 100
            })
        });
        
        alert(`Session completed!\nTime: ${Math.floor(completedDuration/60)}:${(completedDuration%60).toString().padStart(2,'0')}\nFocus Score: ${focusScore}%`);
    }
    
    remainingSeconds = totalSeconds;
    updateDisplay();
}

function updateTimer() {
    if (remainingSeconds > 0) {
        remainingSeconds--;
        updateDisplay();
        
        if (remainingSeconds === 0) {
            stopTimer();
            alert('Timer completed! Great job! ðŸŽ‰');
        }
    }
}

function updateDisplay() {
    const minutes = Math.floor(remainingSeconds / 60);
    const seconds = remainingSeconds % 60;
    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('timerDisplay').textContent = display;
    document.getElementById('timeRemaining').textContent = display;
    
    const progress = ((totalSeconds - remainingSeconds) / totalSeconds) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    const focusScore = Math.max(0, 100 - (interruptions * 10));
    document.getElementById('focusScore').textContent = focusScore + '%';
}

function enableFocusLock() {
    const social = document.getElementById('blockSocial').checked;
    const news = document.getElementById('blockNews').checked;
    const gaming = document.getElementById('blockGaming').checked;
    
    if (social || news || gaming) {
        alert('Focus lock enabled! Distracting websites are now blocked.');
    }
}
</script>
{% endblock %}