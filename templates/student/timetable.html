{% extends "base.html" %}\n\n{% block title %}Smart Timetable{% endblock %}\n\n{% block content %}\n<div class=\"card\">\n    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <div>\n            <h1>ðŸ“… Smart Timetable</h1>\n            <p>AI-powered schedule optimization with deadline management</p>\n        </div>\n        <div style=\"display: flex; gap: 1rem;\">\n            <button class=\"btn btn-success\" onclick=\"showAddDeadlineModal()\">âž• Add Deadline</button>\n            <button class=\"btn\" onclick=\"generateTimetable()\">ðŸ¤– Generate AI Timetable</button>\n        </div>\n    </div>\n</div>\n\n<div class=\"stats\">\n    <div class=\"stat-item\">\n        <h3 id=\"totalDeadlines\">{{ deadlines|length }}</h3>\n        <p>Total Deadlines</p>\n    </div>\n    <div class=\"stat-item\">\n        <h3 id=\"upcomingDeadlines\">0</h3>\n        <p>Upcoming (7 days)</p>\n    </div>\n    <div class=\"stat-item\">\n        <h3 id=\"completedDeadlines\">0</h3>\n        <p>Completed</p>\n    </div>\n    <div class=\"stat-item\">\n        <h3 id=\"stressLevel\">Low</h3>\n        <p>Stress Level</p>\n    </div>\n</div>\n\n<div class=\"grid\">\n    <div class=\"card\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;\">\n            <h3>ðŸ“… Calendar View</h3>\n            <div style=\"display: flex; gap: 0.5rem;\">\n                <button class=\"btn\" onclick=\"previousMonth()\">â€¹</button>\n                <h4 id=\"currentMonth\" style=\"margin: 0 1rem;\"></h4>\n                <button class=\"btn\" onclick=\"nextMonth()\">â€º</button>\n            </div>\n        </div>\n        <div id=\"calendar-grid\" style=\"display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--glass-border);\"></div>\n    </div>\n    \n    <div class=\"card\">\n        <h3>ðŸ“‹ Deadlines</h3>\n        <div id=\"deadlines-list\" style=\"max-height: 400px; overflow-y: auto;\"></div>\n    </div>\n</div>\n\n<!-- Add Deadline Modal -->\n<div id=\"addDeadlineModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;\">\n    <div style=\"background: var(--glass-bg); padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;\">\n        <h3>Add New Deadline</h3>\n        <form id=\"deadlineForm\" style=\"display: grid; gap: 1rem; margin-top: 1rem;\">\n            <div>\n                <label>Title:</label>\n                <input type=\"text\" id=\"deadlineTitle\" required style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\">\n            </div>\n            <div>\n                <label>Subject:</label>\n                <select id=\"deadlineSubject\" required style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\">\n                    <option value=\"\">Select Subject</option>\n                    <option value=\"Mathematics\">Mathematics</option>\n                    <option value=\"Physics\">Physics</option>\n                    <option value=\"Chemistry\">Chemistry</option>\n                    <option value=\"Computer Science\">Computer Science</option>\n                    <option value=\"English\">English</option>\n                    <option value=\"Other\">Other</option>\n                </select>\n            </div>\n            <div>\n                <label>Due Date:</label>\n                <input type=\"datetime-local\" id=\"deadlineDate\" required style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\">\n            </div>\n            <div>\n                <label>Priority:</label>\n                <select id=\"deadlinePriority\" required style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\">\n                    <option value=\"low\">ðŸŸ¢ Low</option>\n                    <option value=\"medium\">ðŸŸ¡ Medium</option>\n                    <option value=\"high\">ðŸ”´ High</option>\n                    <option value=\"critical\">âš« Critical</option>\n                </select>\n            </div>\n            <div>\n                <label>Estimated Study Hours:</label>\n                <input type=\"number\" id=\"studyHours\" min=\"1\" max=\"100\" value=\"5\" style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\">\n            </div>\n            <div>\n                <label>Description:</label>\n                <textarea id=\"deadlineDescription\" rows=\"3\" style=\"width: 100%; padding: 0.75rem; margin-top: 0.25rem;\"></textarea>\n            </div>\n            <div style=\"display: flex; gap: 1rem; margin-top: 1rem;\">\n                <button type=\"button\" class=\"btn\" onclick=\"closeModal()\">Cancel</button>\n                <button type=\"button\" class=\"btn btn-success\" onclick=\"saveDeadline()\">Save Deadline</button>\n            </div>\n        </form>\n    </div>\n</div>\n\n<!-- AI Timetable Modal -->\n<div id=\"timetableModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;\">\n    <div style=\"background: var(--glass-bg); padding: 2rem; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;\">\n            <h3>ðŸ¤– AI Generated Study Timetable</h3>\n            <button onclick=\"closeModal()\" style=\"background: none; border: none; font-size: 1.5rem; cursor: pointer;\">âœ•</button>\n        </div>\n        <div id=\"timetable-content\">\n            <div style=\"text-align: center; padding: 2rem;\">\n                <div class=\"loading-spinner\" style=\"margin: 0 auto 1rem;\"></div>\n                <p>AI is analyzing your deadlines and generating optimal study schedule...</p>\n            </div>\n        </div>\n        <div style=\"display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;\">\n            <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            <button class=\"btn\" onclick=\"applyTimetable()\" id=\"applyBtn\" style=\"display: none;\">ðŸ“… Add to Calendar</button>\n        </div>\n    </div>\n</div>\n\n<style>\n.calendar-day {\n    background: var(--glass-bg);\n    padding: 0.5rem;\n    min-height: 80px;\n    border-radius: 4px;\n    position: relative;\n}\n\n.calendar-day.other-month {\n    opacity: 0.5;\n}\n\n.day-number {\n    font-weight: bold;\n    margin-bottom: 0.25rem;\n}\n\n.deadline-item {\n    background: var(--accent-primary);\n    color: white;\n    padding: 0.25rem;\n    border-radius: 4px;\n    font-size: 0.7rem;\n    margin-bottom: 0.25rem;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.deadline-item.priority-high {\n    background: var(--accent-red);\n}\n\n.deadline-item.priority-critical {\n    background: #000;\n}\n\n.deadline-item.priority-low {\n    background: var(--accent-green);\n}\n\n.deadline-card {\n    background: var(--bg-secondary);\n    padding: 1rem;\n    border-radius: 8px;\n    margin-bottom: 0.5rem;\n    border-left: 4px solid var(--accent-primary);\n}\n\n.deadline-card.priority-high {\n    border-left-color: var(--accent-red);\n}\n\n.deadline-card.priority-critical {\n    border-left-color: #000;\n}\n\n.deadline-card.priority-low {\n    border-left-color: var(--accent-green);\n}\n</style>\n\n<script>\nlet currentDate = new Date();\nlet deadlines = {{ deadlines|tojson|safe }};\nlet generatedTimetable = null;\n\ndocument.addEventListener('DOMContentLoaded', function() {\n    loadDeadlines();\n    updateCalendar();\n    updateStats();\n});\n\nfunction loadDeadlines() {\n    deadlines.forEach(deadline => {\n        deadline.dueDate = new Date(deadline[4]);\n        deadline.id = deadline[0];\n        deadline.title = deadline[1];\n        deadline.subject = deadline[2];\n        deadline.priority = deadline[5];\n        deadline.studyHours = deadline[6];\n        deadline.completed = deadline[8];\n        deadline.description = deadline[7];\n    });\n    \n    updateDeadlinesList();\n    updateStats();\n}\n\nfunction updateCalendar() {\n    const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n    \n    document.getElementById('currentMonth').textContent = \n        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;\n    \n    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);\n    const startDate = new Date(firstDay);\n    startDate.setDate(startDate.getDate() - firstDay.getDay());\n    \n    const calendarGrid = document.getElementById('calendar-grid');\n    calendarGrid.innerHTML = '';\n    \n    // Add day headers\n    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n    dayHeaders.forEach(day => {\n        const dayHeader = document.createElement('div');\n        dayHeader.style.cssText = 'padding: 0.5rem; font-weight: bold; text-align: center; background: var(--bg-secondary);';\n        dayHeader.textContent = day;\n        calendarGrid.appendChild(dayHeader);\n    });\n    \n    // Add calendar days\n    for (let i = 0; i < 42; i++) {\n        const cellDate = new Date(startDate);\n        cellDate.setDate(startDate.getDate() + i);\n        \n        const dayCell = document.createElement('div');\n        dayCell.className = `calendar-day ${cellDate.getMonth() !== currentDate.getMonth() ? 'other-month' : ''}`;\n        \n        const dayNumber = document.createElement('div');\n        dayNumber.className = 'day-number';\n        dayNumber.textContent = cellDate.getDate();\n        dayCell.appendChild(dayNumber);\n        \n        // Add deadlines for this day\n        const dayDeadlines = deadlines.filter(deadline => \n            deadline.dueDate.toDateString() === cellDate.toDateString()\n        );\n        \n        dayDeadlines.forEach(deadline => {\n            const deadlineEl = document.createElement('div');\n            deadlineEl.className = `deadline-item priority-${deadline.priority}`;\n            deadlineEl.textContent = deadline.title;\n            deadlineEl.title = `${deadline.title} - ${deadline.subject}`;\n            dayCell.appendChild(deadlineEl);\n        });\n        \n        calendarGrid.appendChild(dayCell);\n    }\n}\n\nfunction updateDeadlinesList() {\n    const deadlinesList = document.getElementById('deadlines-list');\n    deadlinesList.innerHTML = '';\n    \n    const sortedDeadlines = deadlines\n        .filter(d => !d.completed)\n        .sort((a, b) => a.dueDate - b.dueDate);\n    \n    if (sortedDeadlines.length === 0) {\n        deadlinesList.innerHTML = '<p style=\"text-align: center; color: var(--text-secondary);\">No pending deadlines</p>';\n        return;\n    }\n    \n    sortedDeadlines.forEach(deadline => {\n        const daysLeft = Math.ceil((deadline.dueDate - new Date()) / (1000 * 60 * 60 * 24));\n        const deadlineEl = document.createElement('div');\n        deadlineEl.className = `deadline-card priority-${deadline.priority}`;\n        deadlineEl.innerHTML = `\n            <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;\">\n                <h4 style=\"margin: 0;\">${deadline.title}</h4>\n                <span style=\"font-size: 1.2rem;\">\n                    ${deadline.priority === 'critical' ? 'âš«' : \n                      deadline.priority === 'high' ? 'ðŸ”´' : \n                      deadline.priority === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢'}\n                </span>\n            </div>\n            <div style=\"color: var(--text-secondary); font-size: 0.9rem;\">\n                <p style=\"margin: 0.25rem 0;\">${deadline.subject}</p>\n                <p style=\"margin: 0.25rem 0;\">${daysLeft > 0 ? `${daysLeft} days left` : 'Due today!'}</p>\n                <p style=\"margin: 0.25rem 0;\">${deadline.studyHours}h study time</p>\n            </div>\n            <div style=\"display: flex; gap: 0.5rem; margin-top: 0.5rem;\">\n                <button class=\"btn btn-success\" style=\"padding: 0.25rem 0.5rem; font-size: 0.8rem;\" onclick=\"markCompleted(${deadline.id})\">âœ“ Complete</button>\n                <button class=\"btn btn-danger\" style=\"padding: 0.25rem 0.5rem; font-size: 0.8rem;\" onclick=\"deleteDeadline(${deadline.id})\">âœ— Delete</button>\n            </div>\n        `;\n        deadlinesList.appendChild(deadlineEl);\n    });\n}\n\nfunction updateStats() {\n    const total = deadlines.length;\n    const upcoming = deadlines.filter(d => {\n        const daysLeft = (d.dueDate - new Date()) / (1000 * 60 * 60 * 24);\n        return !d.completed && daysLeft <= 7 && daysLeft >= 0;\n    }).length;\n    const completed = deadlines.filter(d => d.completed).length;\n    \n    const highPriority = deadlines.filter(d => !d.completed && d.priority === 'high').length;\n    const criticalPriority = deadlines.filter(d => !d.completed && d.priority === 'critical').length;\n    \n    let stressLevel = 'Low';\n    if (criticalPriority > 0 || highPriority > 2) stressLevel = 'High';\n    else if (highPriority > 0 || upcoming > 3) stressLevel = 'Medium';\n    \n    document.getElementById('totalDeadlines').textContent = total;\n    document.getElementById('upcomingDeadlines').textContent = upcoming;\n    document.getElementById('completedDeadlines').textContent = completed;\n    document.getElementById('stressLevel').textContent = stressLevel;\n}\n\nfunction showAddDeadlineModal() {\n    document.getElementById('addDeadlineModal').style.display = 'flex';\n}\n\nfunction saveDeadline() {\n    const title = document.getElementById('deadlineTitle').value;\n    const subject = document.getElementById('deadlineSubject').value;\n    const dueDate = document.getElementById('deadlineDate').value;\n    const priority = document.getElementById('deadlinePriority').value;\n    const studyHours = parseInt(document.getElementById('studyHours').value);\n    const description = document.getElementById('deadlineDescription').value;\n    \n    if (!title || !subject || !dueDate || !priority) {\n        alert('Please fill in all required fields');\n        return;\n    }\n    \n    fetch('/calendar/add-deadline', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: new URLSearchParams({\n            title: title,\n            subject: subject,\n            due_date: dueDate,\n            priority: priority,\n            study_hours: studyHours,\n            description: description\n        })\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            alert('Deadline added successfully!');\n            location.reload();\n        } else {\n            alert('Error adding deadline');\n        }\n    });\n}\n\nfunction generateTimetable() {\n    document.getElementById('timetableModal').style.display = 'flex';\n    \n    fetch('/calendar/generate-timetable', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n        }\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            generatedTimetable = data.timetable;\n            displayTimetable(data.timetable);\n            document.getElementById('applyBtn').style.display = 'inline-block';\n        } else {\n            document.getElementById('timetable-content').innerHTML = `\n                <div style=\"background: var(--accent-orange); color: white; padding: 1rem; border-radius: 8px;\">\n                    <h4>No Timetable Generated</h4>\n                    <p>${data.message}</p>\n                </div>\n            `;\n        }\n    });\n}\n\nfunction displayTimetable(timetable) {\n    const content = document.getElementById('timetable-content');\n    \n    let html = `\n        <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; text-align: center;\">\n            <div style=\"background: var(--bg-secondary); padding: 1rem; border-radius: 8px;\">\n                <h3>${timetable.total_sessions}</h3>\n                <p>Study Sessions</p>\n            </div>\n            <div style=\"background: var(--bg-secondary); padding: 1rem; border-radius: 8px;\">\n                <h3>${timetable.total_hours}h</h3>\n                <p>Total Study Time</p>\n            </div>\n            <div style=\"background: var(--bg-secondary); padding: 1rem; border-radius: 8px;\">\n                <h3>${timetable.subjects.length}</h3>\n                <p>Subjects</p>\n            </div>\n        </div>\n    `;\n    \n    timetable.daily_schedule.forEach(day => {\n        if (day.sessions.length === 0) return;\n        \n        html += `\n            <div style=\"margin-bottom: 2rem;\">\n                <h4 style=\"background: var(--accent-primary); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;\">\n                    ${day.day_name} - ${day.date}\n                </h4>\n        `;\n        \n        day.sessions.forEach(session => {\n            const bgColor = session.title.includes('Break') ? 'var(--bg-secondary)' : \n                           session.stress_level === 'critical' ? 'var(--accent-red)' :\n                           session.stress_level === 'high' ? 'var(--accent-orange)' : 'var(--accent-primary)';\n            \n            html += `\n                <div style=\"background: ${bgColor}; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <h5 style=\"margin: 0;\">${session.title}</h5>\n                        <p style=\"margin: 0.25rem 0; opacity: 0.9;\">${session.description}</p>\n                    </div>\n                    <div style=\"text-align: right;\">\n                        <div style=\"font-weight: bold;\">${session.time}</div>\n                        <div style=\"font-size: 0.9rem; opacity: 0.8;\">${session.duration}</div>\n                    </div>\n                </div>\n            `;\n        });\n        \n        html += '</div>';\n    });\n    \n    content.innerHTML = html;\n}\n\nfunction applyTimetable() {\n    if (!generatedTimetable) {\n        alert('No timetable to apply');\n        return;\n    }\n    \n    fetch('/calendar/apply-timetable', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ timetable: generatedTimetable })\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            alert('ðŸ“… Timetable added to your calendar successfully!');\n            closeModal();\n            setTimeout(() => location.reload(), 500);\n        } else {\n            alert('Error applying timetable: ' + data.message);\n        }\n    });\n}\n\nfunction markCompleted(id) {\n    const deadline = deadlines.find(d => d.id === id);\n    if (deadline) {\n        deadline.completed = true;\n        updateCalendar();\n        updateDeadlinesList();\n        updateStats();\n    }\n}\n\nfunction deleteDeadline(id) {\n    if (confirm('Are you sure you want to delete this deadline?')) {\n        deadlines = deadlines.filter(d => d.id !== id);\n        updateCalendar();\n        updateDeadlinesList();\n        updateStats();\n    }\n}\n\nfunction closeModal() {\n    document.getElementById('addDeadlineModal').style.display = 'none';\n    document.getElementById('timetableModal').style.display = 'none';\n}\n\nfunction previousMonth() {\n    currentDate.setMonth(currentDate.getMonth() - 1);\n    updateCalendar();\n}\n\nfunction nextMonth() {\n    currentDate.setMonth(currentDate.getMonth() + 1);\n    updateCalendar();\n}\n</script>\n{% endblock %}