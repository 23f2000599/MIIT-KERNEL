{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>ğŸ“… Smart Calendar</h2>
                    <p class="text-muted">AI-powered schedule optimization with deadline management</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="showAddDeadlineModal()">
                        â• Add Deadline
                    </button>
                    <button class="btn btn-primary" onclick="generateTimetable()">
                        ğŸ¤– Generate AI Timetable
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon">ğŸ“š</div>
                    <h5>Total Deadlines</h5>
                    <h3 class="text-primary" id="totalDeadlines">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon">â°</div>
                    <h5>Upcoming (7 days)</h5>
                    <h3 class="text-warning" id="upcomingDeadlines">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon">ğŸ¯</div>
                    <h5>Completed</h5>
                    <h3 class="text-success" id="completedDeadlines">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon">âš¡</div>
                    <h5>Stress Level</h5>
                    <h3 class="text-danger" id="stressLevel">Low</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>ğŸ“… Calendar View</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="changeView('month')">Month</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeView('week')">Week</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar-container">
                        <div class="calendar-header mb-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="previousMonth()">â€¹</button>
                            <h4 id="currentMonth" class="mx-3"></h4>
                            <button class="btn btn-sm btn-outline-secondary" onclick="nextMonth()">â€º</button>
                        </div>
                        <div id="calendar-grid" class="calendar-grid"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“‹ Deadlines</h5>
                </div>
                <div class="card-body">
                    <div id="deadlines-list" class="deadlines-list">
                        <!-- Deadlines will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Deadline Modal -->
<div class="modal fade" id="addDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Deadline</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deadlineForm">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="deadlineTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select class="form-control" id="deadlineSubject" required>
                            <option value="">Select Subject</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="English">English</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-control" id="deadlineDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-control" id="deadlinePriority" required>
                            <option value="low">ğŸŸ¢ Low</option>
                            <option value="medium">ğŸŸ¡ Medium</option>
                            <option value="high">ğŸ”´ High</option>
                            <option value="critical">âš« Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Estimated Study Hours</label>
                        <input type="number" class="form-control" id="studyHours" min="1" max="100" value="5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="deadlineDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDeadline()">Save Deadline</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Timetable Modal -->
<div class="modal fade" id="timetableModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ¤– AI Generated Study Timetable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="timetable-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">AI is analyzing your deadlines and generating optimal study schedule...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="applyTimetable()" id="applyBtn" style="display: none;">
                    ğŸ“… Add to Calendar
                </button>
                <button type="button" class="btn btn-success" onclick="emailTimetable()" id="emailBtn" style="display: none;">
                    ğŸ“§ Email Timetable
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
let deadlines = [];
let generatedTimetable = null;

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    loadDeadlines();
    updateCalendar();
    updateStats();
});

function loadDeadlines() {
    // Load deadlines from server data
    deadlines = {{ deadlines|tojson|safe }};
    
    // Convert date strings to Date objects
    deadlines.forEach(deadline => {
        deadline.dueDate = new Date(deadline[4]); // due_date column
        deadline.id = deadline[0]; // id column
        deadline.title = deadline[1]; // title column
        deadline.subject = deadline[2]; // subject column
        deadline.priority = deadline[5]; // priority column
        deadline.studyHours = deadline[6]; // study_hours column
        deadline.completed = deadline[8]; // completed column
        deadline.description = deadline[7]; // description column
    });
    
    updateDeadlinesList();
    updateStats();
}

function updateCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });
    
    // Add calendar days
    for (let i = 0; i < 42; i++) {
        const cellDate = new Date(startDate);
        cellDate.setDate(startDate.getDate() + i);
        
        const dayCell = document.createElement('div');
        dayCell.className = `calendar-day ${cellDate.getMonth() !== currentDate.getMonth() ? 'other-month' : ''}`;
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = cellDate.getDate();
        dayCell.appendChild(dayNumber);
        
        // Add deadlines for this day
        const dayDeadlines = deadlines.filter(deadline => 
            deadline.dueDate.toDateString() === cellDate.toDateString()
        );
        
        dayDeadlines.forEach(deadline => {
            const deadlineEl = document.createElement('div');
            deadlineEl.className = `deadline-item priority-${deadline.priority}`;
            deadlineEl.textContent = deadline.title;
            deadlineEl.title = `${deadline.title} - ${deadline.subject}`;
            dayCell.appendChild(deadlineEl);
        });
        
        // Add timetable entries for this day
        const timetableEntries = {{ timetable_entries|tojson|safe }} || [];
        console.log('Timetable entries:', timetableEntries); // Debug log
        const dayEntries = timetableEntries.filter(entry => {
            const entryDate = new Date(entry[2]); // start_time column
            console.log('Entry date:', entryDate, 'Cell date:', cellDate); // Debug log
            return entryDate.toDateString() === cellDate.toDateString();
        });
        
        console.log('Day entries for', cellDate.toDateString(), ':', dayEntries); // Debug log
        dayEntries.forEach(entry => {
            const entryEl = document.createElement('div');
            entryEl.className = `deadline-item priority-${entry[7]} timetable-entry`; // priority column
            entryEl.textContent = entry[1]; // title column
            entryEl.title = `${entry[1]} - ${entry[4]} (Study Session)`; // title, subject
            dayCell.appendChild(entryEl);
        });
        
        calendarGrid.appendChild(dayCell);
    }
}

function updateDeadlinesList() {
    const deadlinesList = document.getElementById('deadlines-list');
    deadlinesList.innerHTML = '';
    
    const sortedDeadlines = deadlines
        .filter(d => !d.completed)
        .sort((a, b) => a.dueDate - b.dueDate);
    
    if (sortedDeadlines.length === 0) {
        deadlinesList.innerHTML = '<p class="text-muted text-center">No pending deadlines</p>';
        return;
    }
    
    sortedDeadlines.forEach(deadline => {
        const daysLeft = Math.ceil((deadline.dueDate - new Date()) / (1000 * 60 * 60 * 24));
        const deadlineEl = document.createElement('div');
        deadlineEl.className = `deadline-card priority-${deadline.priority}`;
        deadlineEl.innerHTML = `
            <div class="deadline-header">
                <h6>${deadline.title}</h6>
                <span class="priority-badge priority-${deadline.priority}">
                    ${deadline.priority === 'critical' ? 'âš«' : 
                      deadline.priority === 'high' ? 'ğŸ”´' : 
                      deadline.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'}
                </span>
            </div>
            <div class="deadline-info">
                <small class="text-muted">${deadline.subject}</small>
                <div class="deadline-time">
                    ${daysLeft > 0 ? `${daysLeft} days left` : 'Due today!'}
                </div>
                <div class="study-hours">${deadline.studyHours}h study time</div>
            </div>
            <div class="deadline-actions">
                <button class="btn btn-sm btn-success" onclick="markCompleted(${deadline.id})">âœ“</button>
                <button class="btn btn-sm btn-danger" onclick="deleteDeadline(${deadline.id})">âœ—</button>
            </div>
        `;
        deadlinesList.appendChild(deadlineEl);
    });
}

function updateStats() {
    const total = deadlines.length;
    const upcoming = deadlines.filter(d => {
        const daysLeft = (d.dueDate - new Date()) / (1000 * 60 * 60 * 24);
        return !d.completed && daysLeft <= 7 && daysLeft >= 0;
    }).length;
    const completed = deadlines.filter(d => d.completed).length;
    
    // Calculate stress level
    const highPriority = deadlines.filter(d => !d.completed && d.priority === 'high').length;
    const criticalPriority = deadlines.filter(d => !d.completed && d.priority === 'critical').length;
    
    let stressLevel = 'Low';
    if (criticalPriority > 0 || highPriority > 2) stressLevel = 'High';
    else if (highPriority > 0 || upcoming > 3) stressLevel = 'Medium';
    
    document.getElementById('totalDeadlines').textContent = total;
    document.getElementById('upcomingDeadlines').textContent = upcoming;
    document.getElementById('completedDeadlines').textContent = completed;
    document.getElementById('stressLevel').textContent = stressLevel;
}

function showAddDeadlineModal() {
    const modal = new bootstrap.Modal(document.getElementById('addDeadlineModal'));
    modal.show();
}

function saveDeadline() {
    const title = document.getElementById('deadlineTitle').value;
    const subject = document.getElementById('deadlineSubject').value;
    const dueDate = document.getElementById('deadlineDate').value;
    const priority = document.getElementById('deadlinePriority').value;
    const studyHours = parseInt(document.getElementById('studyHours').value);
    const description = document.getElementById('deadlineDescription').value;
    
    if (!title || !subject || !dueDate || !priority) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch('/calendar/add-deadline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            title: title,
            subject: subject,
            due_date: dueDate,
            priority: priority,
            study_hours: studyHours,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Deadline added successfully!');
            location.reload();
        } else {
            alert('Error adding deadline');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding deadline');
    });
}

function markCompleted(id) {
    const deadline = deadlines.find(d => d.id === id);
    if (deadline) {
        deadline.completed = true;
        updateCalendar();
        updateDeadlinesList();
        updateStats();
    }
}

function deleteDeadline(id) {
    if (confirm('Are you sure you want to delete this deadline?')) {
        deadlines = deadlines.filter(d => d.id !== id);
        updateCalendar();
        updateDeadlinesList();
        updateStats();
    }
}

function generateTimetable() {
    const modal = new bootstrap.Modal(document.getElementById('timetableModal'));
    modal.show();
    
    // Call server to generate AI timetable
    fetch('/calendar/generate-timetable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            generatedTimetable = data.timetable;
            displayTimetable(data.timetable);
            document.getElementById('emailBtn').style.display = 'inline-block';
            document.getElementById('applyBtn').style.display = 'inline-block';
        } else {
            document.getElementById('timetable-content').innerHTML = `
                <div class="alert alert-warning">
                    <h5>No Timetable Generated</h5>
                    <p>${data.message}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('timetable-content').innerHTML = `
            <div class="alert alert-danger">
                <h5>Error</h5>
                <p>Failed to generate timetable. Please try again.</p>
            </div>
        `;
    });
}

function generateAITimetable() {
    const pendingDeadlines = deadlines.filter(d => !d.completed);
    const timetable = {
        overview: {
            totalDeadlines: pendingDeadlines.length,
            totalStudyHours: pendingDeadlines.reduce((sum, d) => sum + d.studyHours, 0),
            averageHoursPerDay: 0
        },
        schedule: []
    };
    
    // Generate 7-day schedule
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        
        const daySchedule = {
            date: date.toDateString(),
            sessions: []
        };
        
        // Morning session (9-11 AM)
        if (pendingDeadlines.length > 0) {
            const deadline = pendingDeadlines[i % pendingDeadlines.length];
            daySchedule.sessions.push({
                time: '09:00 - 11:00',
                subject: deadline.subject,
                task: `Study for ${deadline.title}`,
                duration: '2 hours',
                priority: deadline.priority,
                type: 'study'
            });
        }
        
        // Break
        daySchedule.sessions.push({
            time: '11:00 - 11:30',
            subject: 'Break',
            task: 'Rest and refresh',
            duration: '30 minutes',
            priority: 'low',
            type: 'break'
        });
        
        // Afternoon session (2-4 PM)
        if (pendingDeadlines.length > 1) {
            const deadline = pendingDeadlines[(i + 1) % pendingDeadlines.length];
            daySchedule.sessions.push({
                time: '14:00 - 16:00',
                subject: deadline.subject,
                task: `Practice problems for ${deadline.title}`,
                duration: '2 hours',
                priority: deadline.priority,
                type: 'practice'
            });
        }
        
        // Evening review (7-8 PM)
        daySchedule.sessions.push({
            time: '19:00 - 20:00',
            subject: 'Review',
            task: 'Review today\'s learning',
            duration: '1 hour',
            priority: 'medium',
            type: 'review'
        });
        
        timetable.schedule.push(daySchedule);
    }
    
    timetable.overview.averageHoursPerDay = 
        timetable.schedule.reduce((sum, day) => 
            sum + day.sessions.filter(s => s.type !== 'break').length * 1.5, 0) / 7;
    
    generatedTimetable = timetable;
    return timetable;
}

function displayTimetable(timetable) {
    const content = document.getElementById('timetable-content');
    
    let html = `
        <div class="timetable-overview mb-4">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="stat-card">
                        <h4>${timetable.total_sessions}</h4>
                        <p>Study Sessions</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h4>${timetable.total_hours}h</h4>
                        <p>Total Study Time</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h4>${timetable.subjects.length}</h4>
                        <p>Subjects</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="timetable-schedule">
    `;
    
    timetable.daily_schedule.forEach(day => {
        if (day.sessions.length === 0) return; // Skip empty days
        
        html += `
            <div class="day-schedule mb-4">
                <h5 class="day-header">${day.day_name} - ${day.date}</h5>
                <div class="sessions">
        `;
        
        day.sessions.forEach(session => {
            const sessionClass = session.title.includes('Break') ? 'session-break' : 
                               session.stress_level === 'critical' ? 'session-critical' :
                               session.stress_level === 'high' ? 'session-high' :
                               session.stress_level === 'medium' ? 'session-medium' : 'session-low';
            
            html += `
                <div class="session-card ${sessionClass}">
                    <div class="session-time">${session.time}</div>
                    <div class="session-content">
                        <h6>${session.title}</h6>
                        <p>${session.description}</p>
                        <small>${session.duration}</small>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    content.innerHTML = html;
}

function applyTimetable() {
    if (!generatedTimetable) {
        alert('No timetable to apply');
        return;
    }
    
    fetch('/calendar/apply-timetable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ timetable: generatedTimetable })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ğŸ“… Timetable added to your calendar successfully!');
            // Close modal first
            bootstrap.Modal.getInstance(document.getElementById('timetableModal')).hide();
            // Then reload to show new entries
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error applying timetable: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error applying timetable');
    });
}

function emailTimetable() {
    if (!generatedTimetable) {
        alert('No timetable to email');
        return;
    }
    
    // Simulate email sending
    alert('ğŸ“§ Timetable has been emailed to your registered email address!');
    
    // In real implementation, make API call to send email
    // fetch('/calendar/email-timetable', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify({ timetable: generatedTimetable })
    // });
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendar();
}

function changeView(view) {
    // Implement view change logic
    alert(`Switching to ${view} view`);
}
</script>
{% endblock %}